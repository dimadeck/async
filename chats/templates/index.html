<!DOCTYPE html>
<meta charset="utf-8"/>
<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js">
    </script>
    <script language="javascript" type="text/javascript">
    $(function() {
      var conn = null;
      var login_status = false;
      var send_mode = 'msgall';
      update_ui();
      $('#field_name').val('').focus();
      function log(msg) {
        var control = $('#log');
        control.html(control.html() + msg + '<br/>');
        control.scrollTop(control.scrollTop() + 1000);
      }
      function connect() {
        disconnect();
        var wsUri = (window.location.protocol=='https:'&&'wss://'||'ws://')+window.location.host+'/ws';
        conn = new WebSocket(wsUri);
        var name = $('#field_name').val();
        login_status = false;
        conn.onopen = function() {
                  conn.send('login '+name);
                  update_ui();
                };
        conn.onmessage = function(e) {
          var data = JSON.parse(e.data);
          switch (data.action)
          {
            case 'response':
            log(data.message);
            if (login_status == false){
              if (data.message.indexOf('login to chat')>0){
                login_status = true;
              }
            }
            if (login_status == true){
            conn.send('/userlist');
            update_ui();
            }
            break;
            case 'list':
            $('#user_list').empty();
            $('#user_list').append($('<option>',
            {
              value: 'all',
              text: 'All'
            }));
            for (i in data.message)
            {
              $('#user_list').append($('<option>',
              {
                value: data.message[i],
                text: data.message[i]
              }));
            }
            break;
          }
        };
        conn.onclose = function() {
          log('Disconnected.');
          conn = null;
          login_status = false;
          update_ui();
        };
      }
      function disconnect() {
        if (login_status == true) {
          conn.send('logout');
          update_ui();
        }
      }
      function update_ui() {
        if (login_status == false) {
          $('#status').prop("src", 'http://3d-zambia.chordsrt.com/assets/button_red_50-0e9cba6bd7edd35e3a03f351748610225ed9c3d6208b6a705973d314014fe8da.png');
          $('#connect').prop("value", 'Login');
          $('#send').prop("disabled", true);
          $('#name').prop("hidden", true);
          $('#field_name').prop("hidden", false);
          $('#field_name').val('').focus();
        } else {
          $('#status').prop("src", 'http://www.clker.com/cliparts/4/t/n/Q/b/d/green-glossy-icon-th.png');
          $('#connect').prop("value", 'Logout');
          $('#send').prop("disabled", false);
          $('#name').prop("hidden", false);
          $('#field_name').prop("hidden", true);
          $('#text').val('').focus();
        }
        $('#name').text(name);
      };
      $('#connect').on('click', function() {
        if (conn == null) {
          connect();
        } else {
          disconnect();
        }
        if (login_status == false){
          name = $('#field_name').val();
          conn.send('login '+name);
        }
        update_ui();
        return false;
      });
      $('#field_name').on('keyup', function(e) {
        if (e.keyCode === 13) {
          $('#connect').click();
          return false;
        }
      });
      // Login end
      // Send start
      $('#send').on('click', function() {
        var text = $('#text').val();
        conn.send(send_mode+' '+text);
        $('#text').val('').focus();
        return false;
      });
      $('#text').on('keyup', function(e) {
        if (e.keyCode === 13) {
          $('#send').click();
          return false;
        }
      });
     // Send end
     // Command line start
      $('#cmd_btn').on('click', function() {
        var cmd = $('#cmd_line').val();
        conn.send(cmd);
        $('#cmd_line').val('').focus();
        return false;
      });
      $('#cmd_line').on('keyup', function(e) {
        if (e.keyCode === 13) {
          $('#cmd_btn').click();
          return false;
        }
      });
      // Command line end
      $('#user_list').on('dblclick', function() {
        var list = document.getElementById("user_list");
        index = list.options.selectedIndex;
        if (index >= 0)
        {
          value = list.options[index].value;
          if (value == 'all'){
            send_mode = 'msgall';
          }
          else{
            send_mode = 'msg '+value;
          }
        }
        else{
          send_mode = 'msgall';
        }
        return false;
      });
    });
   </script>
</head>
<body>
<h3><img id="status" width=15 height=15> <span id="chat_version">{{version}}</span></h3>
<div>
    <div>Command Line
      <form id="cmdform" onsubmit="return false;">
          <input style="width:20em" id="cmd_line" type="text"/>
          <input id="cmd_btn" type="button" value="SEND">
      </form>
    </div>
    <br>
    <div>
      <select size=5 style="width:20em" id="user_list">
      </select>
    </div>
    <br>
    <div>Name:<span hidden=true id="name"></span>
    <form id="loginform" onsubmit="return false;">
        <input style="width:15em" id="field_name" type="text"/>
        <input id="connect" type="button" value="Login">
    </form>
    </div>
</div>
<div id="log"
     style="width:20em;height:15em;overflow:auto;border:1px solid black">
</div>
<form id="chatform" onsubmit="return false;">
    <input id="text" type="text"/>
    <input id="send" type="button" value="Send" disabled/>
</form>
</body>
</html>
